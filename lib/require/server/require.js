/*** Generated by streamline 0.1.22 - DO NOT EDIT ***/

"use strict";
var __global = typeof global !== 'undefined' ? global : window;
function __cb(_, fn) { var ctx = __global.__context; return function(err, result) { __global.__context = ctx; if (err) return _(err); return fn(null, result); } }
function __future(fn, args, i) { var done, err, result; var cb = function(e, r) { done = true; err = e, result = r; }; args = Array.prototype.slice.call(args); args[i] = function(e, r) { cb(e, r); }; fn.apply(this, args); return function(_) { if (done) _.call(this, err, result); else cb = _.bind(this); }.bind(this); }
function __propagate(_, err) { try { _(err); } catch (ex) { __trap(ex); } }
function __trap(err) { if (err) { if (__global.__context && __global.__context.errorHandler) __global.__context.errorHandler(err); else console.error("UNCAUGHT EXCEPTION: " + err.message + "\n" + err.stack); } }
var fs = require("fs");
var depend = require("./depend");
var flows = require("streamline/lib/util/flows");
var uuid = require("streamline/lib/util/uuid");
var each = flows.each;
var path = require("path");
var url = require("streamline/lib/util/url");
function _replyError(response, statusCode, body) {
  response.writeHead(statusCode, {
    "Content-Type": "text/plain",
    "Content-Length": body.length
  });
  response.end(body);
};
exports.dispatcher = function __1(config) {
  config = (config || {
  });
  var root = (config.root || path.join(__dirname, "../../../../.."));
  return function __1(_, request, response) {
    if (!_) {
      return __future(__1, arguments, 0);
    }
  ;
    var __then = _;
    return function(__then) {
      return function(_) {
        try {
          var noneMatch = request.headers["if-none-match"];
          if ((noneMatch === depend.etag())) {
            response.writeHead(304, {
            });
            return _(null, response.end());
          }
        ;
          var parts = request.url.split("?");
          var qs = url.parseQueryString(parts[1]);
          var path = qs["module"];
          var known = ((qs["known"] || "")).split(",");
          if ((path[0] == ".")) {
            return _(new Error(("server require cannot resolve relative path: " + path)))
          };
          path = ((path[0] == "/") ? (root + path) : ((root + "/node_modules/") + path));
          return fs.stat((path + ".js"), __cb(_, function(__0, stats) {
            if (!stats.isFile()) {
              return _(null, _replyError(response, 404, ("file not found " + path)))
            };
            return depend.missingDependencies(__cb(_, function(__0, missing) {
              var accept = request.headers.accept;
              return function(__then) {
                if ((accept.indexOf("text/html") == 0)) {
                  response.writeHead(200, {
                    "content-type": "text/html",
                    ETag: depend.etag()
                  });
                  return response.write(__cb(_, function() {
                    response.end();
                    return _(null);
                  }), ((((((("<html>" + "\n<head><title>dependencies: ") + path) + "</title></head>") + "\n<body><ul>") + missing.sort().map(function __1(dep) {
                    dep = dep.substring((root.length + 1));
                    return (((("\n<li><a href=\"/require/" + dep) + "\">") + dep) + "</li>");
                  }).join("")) + "\n</ul>") + "\n</body>\n</html>"));
                }
              ;
                return __then();
              }(function() {
                var boundary = uuid.generate();
                var endMarker = (("\n--" + boundary) + "--\n");
                response.writeHead(200, {
                  "Content-Type": (("multipart/related; boundary=\"" + boundary) + "\""),
                  ETag: depend.etag()
                });
                var i = 0;
                return each(__cb(_, function() {
                  response.end(endMarker);
                  return __then();
                }), missing, function __2(_, dep) {
                  if (!_) {
                    return __future(__2, arguments, 0);
                  }
                ;
                  var __then = _;
                  return function(__then) {
                    return function(_) {
                      try {
                        var modIndex = dep.indexOf("/node_modules/");
                        var location = ((modIndex >= 0) ? dep.substring((modIndex + 14)) : dep.substring(root.length));
                        return fs.readFile((dep + ".js"), "utf8", __cb(_, function(__0, data) {
                          return response.write(__cb(_, __then), (((((((((((("\n--" + boundary) + "\n") + "Content-ID: FILE ") + ++i) + "\n") + "Content-Location: ") + location) + "\n") + "Content-Type: application/javascript\n") + "\n") + data) + "\n"));
                        }));
                      } catch (e) {
                        return __propagate(_, e);
                      };
                    }(function(ex, __result) {
                      try {
                        if (ex) {
                          return response.write(__cb(_, function() {
                            response.end(endMarker);
                            return __then();
                          }), ((((((("\n--" + boundary) + "\n") + "Content-ID: ERROR\n") + "Content-Type: text/plain\n") + "\n") + ex.toString()) + "\n"));
                        }
                         else return _(null, __result)
                      ;
                      } catch (e) {
                        return __propagate(_, e);
                      };
                    });
                  }(function() {
                    try {
                      return __then();
                    } catch (e) {
                      return __propagate(_, e);
                    };
                  });
                });
              });
            }), path, known);
          }));
        } catch (e) {
          return __propagate(_, e);
        };
      }(function(ex, __result) {
        try {
          if (ex) {
            console.error(((ex.message + "\n") + ex.stack));
            return _(null, _replyError(response, 500, ex.toString()));
          }
           else return _(null, __result)
        ;
        } catch (e) {
          return __propagate(_, e);
        };
      });
    }(function() {
      try {
        return __then();
      } catch (e) {
        return __propagate(_, e);
      };
    });
  };
};