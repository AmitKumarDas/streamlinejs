/*** Generated by streamline --lines-preserve 0.1.6 - DO NOT EDIT ***/
 var __global = typeof global !== 'undefined' ? global : window; function __cb(_, fn){ var ctx = __global.__context; return function(err, result){ __global.__context = ctx; if (err) return _(err); return fn(null, result); } } function __trap(err){ if (err) { if (__global.__context && __global.__context.errorHandler) __global.__context.errorHandler(err); else console.error("UNCAUGHT EXCEPTION: " + ex.message + "\n" + ex.stack); } } var fs = require("fs");
var path = require("path");
var streamline = require("streamline");
var transform = streamline.transform;
var flows = streamline.flows;

function _exists(fname, callback) {
 path.exists(fname, function(result) {
 callback(null, result); });};



function _mkdir(dir, mode, _) { var __ = (_ = (_ || __trap));
 var p = path.dirname(dir); return function(__) {
 return _exists(p, __cb(_, function(__0, __1) { if (!__1) {
 return _mkdir(p, mode, __cb(_, __.bind(this))); } ; return __(); }.bind(this))); }.call(this, function() {
 return fs.mkdir(dir, mode, __cb(_, __.bind(this))); }.bind(this));};


function _compile(_, input, output, options) { var __ = (_ = (_ || __trap));
 return fs.stat(input, __cb(_, function(__0, stat) {
 if (stat.isDirectory()) {
 output = (output || input);
 return fs.readdir(input, __cb(_, function(__0, __3) { return flows.each(__cb(_, __.bind(this)), __3, function(_, f) { var __ = (_ = (_ || __trap));
 return _compile(__cb(_, __.bind(this)), path.join(input, f), path.join(output, f), options); }); }.bind(this))); } else {



 if ((stat.isFile() && input.match(/_\.js$/))) {
 output = (output || input);
 if (!output.match(/\.js$/)) {
 output = path.join(output, path.basename(input)); };
 output = output.replace(/_\.js$/, ".js");

 return fs.readFile(input, "utf8", __cb(_, function(__0, source) {
 var outDir = path.dirname(output); return function(__) {
 return _exists(outDir, __cb(_, function(__0, __5) { if (!__5) {
 return _mkdir(outDir, 511, __cb(_, __.bind(this))); } ; return __(); }.bind(this))); }.call(this, function() {
 var banner = transform.banner(options); return function(__) { return function(_) { var __ = (_ = (_ || __trap)); return function(_) { var __ = (_ = (_ || __trap)); return function(_) { var __ = (_ = (_ || __trap));
 var __val = !options.force; if ((!__val == true)) { return _(null, __val); } ; return _exists(output, _); }.call(this, __cb(_, function(__0, __val) { if ((!__val == true)) { return _(null, __val); } ; return fs.stat(output, __cb(_, function(__0, __2) { return _(null, (__2.mtime >= stat.mtime)); }.bind(this))); }.bind(this))); }.call(this, __cb(_, function(__0, __val) { if ((!__val == true)) { return _(null, __val); } ;
 return fs.readFile(output, "utf8", __cb(_, function(__0, __2) { return _(null, (__2.substring(0, banner.length) == banner)); }.bind(this))); }.bind(this))); }.call(this, __cb(_, function(__0, __1) { if (__1) { return _(null); } ; return __(); }.bind(this))); }.call(this, function() {


 if (options.verbose) {
 console.log(("compiling " + input)); };
 var transformed = transform.transform(source, options);
 return fs.writeFile(output, (banner + transformed), "utf8", __cb(_, __.bind(this))); }.bind(this)); }.bind(this)); }.bind(this))); } ; return __(); } ; }.bind(this)));};




exports.compile = function(options, _) { var __ = (_ = (_ || __trap));
 options = (options || { });
 if (options.verbose) {
 console.log(("transform version: " + transform.version)); };
 if ((options.inputs.length == 0)) {
 return _(new Error("cannot compile: no files specified")) };
 var cwd = process.cwd;
 return flows.each(__cb(_, __.bind(this)), options.inputs, function(_, input) { var __ = (_ = (_ || __trap));
 return _compile(__cb(_, __.bind(this)), path.join(cwd, input), options.output, options); });};